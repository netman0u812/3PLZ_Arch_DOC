GW-Builder v1.0.6 — Comprehensive Implementation & Functional Testing Plan
==========================================================================

Scope
-----
This plan validates the end-to-end build and operation of the multi-tenant IPsec + mTLS secure gateway:
- Base OS and package installation (Rocky Linux 9)
- Base networking and interfaces
- VRF / tenant isolation model
- IPsec VTI (strongSwan) with per-tenant BGP routing (FRR)
- DNS conditional forwarding + per-tenant rewrite to local proxy VIPs
- Forward proxy plane (Squid; explicit; CONNECT; optional transparent)
- Reverse proxy plane (per-app HTTPS/HTTP proxies with mTLS auth + per-proxy server cert)
- PKI (Root CA + per-tenant Intermediate, user + server cert issuance, revocation/CRL enforcement)
- Firewall policy (nftables)
- Inspection export add-on (Option A: decrypted traffic mirror) including:
  - bidirectional mirroring guarantees
  - nftables allow-list guardrail
  - policing/rate limit guardrail

Assumptions
-----------
- Gateway host has 2 NICs:
  - eth0: underlay / internet / IPsec peer facing
  - eth1: inside/core network egress (internal services)
- GW installed at /opt/gw-builder
- Optional inspection add-on installed at /opt/gw-inspection
- Tenants: at least tenantA + tenantB to validate isolation.
- You have access to:
  - a test IPsec peer (strongSwan/Cisco/Arista)
  - a test internal service (e.g., 10.99.40.7) to be proxied
  - a DNS upstream resolver (e.g., 12.1.2.1) for conditional forwarding
  - an inspection appliance or collector that can ingest ERSPAN/VXLAN

Evidence Collection
-------------------
For each section, collect:
- command outputs (saved text files)
- relevant logs (journalctl, service logs)
- packet captures (on inspection appliance) proving plaintext payload

Pass/Fail Criteria
------------------
PASS requires:
- strict tenant isolation (no route bleed; no cross-tenant reachability)
- IPsec and BGP converge and exchange tenant routes
- DNS rewrite returns tenant-local VIPs and is tenant-scoped
- mTLS enforcement blocks unauthenticated clients; allows valid certs
- per-app server certs present correct identity
- revocation blocks access post-revoke (CRL/OCSP as implemented)
- inspection mirror exports plaintext packet copies without disrupting forwarding
- guardrails work (policing and allow-list do not break forwarding)

SECTION 1 — Install & Baseline Host Validation
----------------------------------------------
1.1 OS baseline
  cat /etc/os-release
  uname -r

1.2 Dependency installation
- Verify required packages:
  rpm -q iproute nftables strongswan frr nginx squid openssl
- Verify services:
  systemctl status nftables || true
  systemctl status strongswan || true
  systemctl status frr || true

1.3 File layout
  test -f /opt/gw-builder/gw.conf
  ls -l /opt/gw-builder/gwctl.sh

SECTION 2 — Base Networking & Interfaces
----------------------------------------
2.1 Interface identity
  ip -br link
  ip -br addr

2.2 Underlay connectivity
  ip route
  ping -c 3 <underlay-gw>

SECTION 3 — Firewall Baseline (nftables)
----------------------------------------
3.1 Enable nftables
  sudo systemctl enable --now nftables
  sudo nft list ruleset

3.2 Validate management access not blocked
- Confirm SSH reachable during test window.

SECTION 4 — PKI (Root + Tenant Intermediate + User + Server)
------------------------------------------------------------
4.1 Init Root CA
  sudo /opt/gw-builder/pki-bootstrap.sh init-root --cn "Outlan Root CA"
  openssl x509 -in /etc/gateway/pki/root/certs/root.cert.pem -noout -subject -issuer

4.2 Init tenant Intermediate
  sudo /opt/gw-builder/pki-bootstrap.sh init-tenant --tenant tenantA
  openssl verify -CAfile /etc/gateway/pki/root/certs/root.cert.pem     /etc/gateway/pki/tenantA/intermediate/certs/tenantA.intermediate.cert.pem

4.3 Issue user cert (sign CSR)
  openssl req -new -newkey rsa:2048 -nodes -keyout alice.key.pem -out alice.csr.pem -subj "/CN=alice@outlan.net"
  /opt/gw-builder/pki-issue.sh sign-user-csr --tenant tenantA --email alice@outlan.net --csr alice.csr.pem --outdir ./alice
  openssl x509 -in ./alice/alice@outlan.net.cert.pem -noout -text | egrep "Subject:|Alternative Name" -n

4.4 Issue server cert (per app)
  /opt/gw-builder/pki-issue.sh issue-server --tenant tenantA --fqdn sap.outlan.net --outdir ./sap
  openssl x509 -in ./sap/sap.outlan.net.cert.pem -noout -text | egrep "Subject:|DNS:" -n

4.5 Revoke + CRL
  sudo /opt/gw-builder/pki-revoke.sh revoke-user --tenant tenantA --email alice@outlan.net
  openssl crl -in /etc/gateway/pki/tenantA/intermediate/crl/tenantA-intermediate.crl.pem -noout -text | head

SECTION 5 — Tenant Build + VRF Isolation
----------------------------------------
5.1 Create tenantA + tenantB
  sudo gwctl tenant-create tenantA
  sudo gwctl tenant-create tenantB

5.2 Verify VRFs
  ip vrf show | egrep "tenantA|tenantB"

5.3 Verify decrypted hop attachment point exists
  ip link show dec-tenantA
  ip link show dec-tenantA-core

5.4 Isolation tests (routes + reachability)
  ip route show vrf vrf-tenantA
  ip route show vrf vrf-tenantB
  # Attempt cross-tenant ping (should fail):
  ip vrf exec vrf-tenantA ping -c 1 <tenantB-service-ip> || true

SECTION 6 — IPsec VTI + BGP
---------------------------
6.1 Start tenantA
  sudo gwctl tenant-start tenantA

6.2 Validate IPsec status
  sudo ipsec statusall | egrep -i "ESTABLISHED|INSTALLED|tenantA" -n

6.3 Validate VTI present
  ip link show | grep -i vti || true

6.4 Validate BGP neighbor
  vtysh -c "show ip bgp summary" | egrep "Neighbor|Estab|Up" -n

6.5 Vendor peer templates
  gwctl ipsec-peer-template tenantA cisco > tenantA-cisco-peer.txt
  gwctl ipsec-peer-template tenantA arista > tenantA-arista-peer.txt

SECTION 7 — DNS Conditional Forward + Rewrite
---------------------------------------------
7.1 DNS listener up
  ss -lntup | grep :53 || true

7.2 Conditional forwarder test
  dig @172.16.100.3 sap.outlan.net

7.3 Rewrite test (after provisioning per-app VIP)
  dig @172.16.100.3 sap.outlan.net
  # expect: 172.16.x.y VIP

SECTION 8 — Forward Proxy (Squid)
---------------------------------
8.1 Listener
  ss -lntup | grep 3128 || true

8.2 Explicit proxy
  curl -x http://172.16.100.1:3128 http://example.com -I

8.3 CONNECT
  curl -x http://172.16.100.1:3128 https://example.com -I

8.4 Transparent (if enabled)
- Validate nft redirect rules exist
- Validate HTTP without proxy settings is intercepted

SECTION 9 — Reverse Proxy (mTLS)
--------------------------------
9.1 No-client-cert blocked
  curl -k https://sap.outlan.net --resolve sap.outlan.net:443:<tenant-vip> -I || true

9.2 Client-cert allowed
  curl --cert ./alice/alice@outlan.net.cert.pem --key ./alice/alice.key.pem     -k https://sap.outlan.net --resolve sap.outlan.net:443:<tenant-vip> -I

9.3 Per-app server cert
  openssl s_client -connect <tenant-vip>:443 -servername sap.outlan.net </dev/null 2>/dev/null | openssl x509 -noout -subject -issuer

9.4 Revocation blocks
  sudo /opt/gw-builder/pki-revoke.sh revoke-user --tenant tenantA --email alice@outlan.net --reload
  curl --cert ./alice/alice@outlan.net.cert.pem --key ./alice/alice.key.pem     -k https://sap.outlan.net --resolve sap.outlan.net:443:<tenant-vip> -I || true

SECTION 10 — Inspection Export Add-on (Option A)
------------------------------------------------
10.1 Install add-on
  unzip gw-inspection-v0.1.1.zip
  cd gw-inspection-v0.1.1
  sudo ./install.sh

10.2 Configure tenantA for tap (ERSPAN)
Edit /opt/gw-builder/tenants/tenantA.conf:
  INSPECTION_EXPORT_MODE=tap
  INSPECTION_TAP_TYPE=erspan
  INSPECTION_TAP_DST_IP=<appliance-ip>
  INSPECTION_TAP_KEY=1001
  INSPECTION_TAP_RATE_BPS=0
  INSPECTION_TAP_ALLOWLIST=<appliance-ip>
  INSPECTION_TAP_EGRESS_IF=eth0

10.3 Apply via lifecycle
  sudo gwctl tenant-restart tenantA

10.4 Verify bidirectional tc rules
  tc -s filter show dev dec-tenantA ingress
  tc -s filter show dev dec-tenantA egress

10.5 Verify tunnel
  ip -d link show erspan-tenantA

10.6 Verify allow-list nftables guardrail
  sudo nft list table inet gw_inspect_allow

10.7 Validate plaintext mirror at appliance
- Generate traffic:
  curl --cert ... --key ... -k https://sap.outlan.net --resolve ...
- On appliance:
  - confirm ERSPAN received
  - confirm inner payload is plaintext HTTP (requests/responses)
- On GW:
  - confirm tc counters increase:
    tc -s filter show dev dec-tenantA ingress
    tc -s filter show dev dec-tenantA egress

10.8 Policing test
- Set INSPECTION_TAP_RATE_BPS=1000000
- Restart tenant
- Generate traffic; confirm:
  - forwarding OK
  - mirror reduced/drops (tc stats show)

10.9 Allow-list negative test
- Set allowlist to wrong IP; restart tenant
- Confirm appliance receives nothing
- Restore correct allowlist; restart; confirm mirror resumes

10.10 Disable tap
- Set INSPECTION_EXPORT_MODE=off
- Restart tenant; confirm:
  - tunnel removed
  - tc rules removed
  - allow-list rules removed

SECTION 11 — Resilience / Idempotency
-------------------------------------
11.1 Appliance down
- With tap enabled, power off appliance
- Verify forwarding continues; mirror drops acceptable

11.2 Repeated apply/remove
  sudo /opt/gw-inspection/gw-inspectctl.sh apply tenantA
  sudo /opt/gw-inspection/gw-inspectctl.sh apply tenantA
  sudo /opt/gw-inspection/gw-inspectctl.sh remove tenantA
  sudo /opt/gw-inspection/gw-inspectctl.sh remove tenantA

- Verify no orphan devices/rules:
  ip link show erspan-tenantA || true
  tc -s filter show dev dec-tenantA ingress || true
  sudo nft list table inet gw_inspect_allow || true

SECTION 12 — Performance Smoke
------------------------------
12.1 Baseline (tap off)
- Measure request latency/throughput to proxied app and to internet via squid

12.2 Tap enabled
- Repeat measurements; quantify overhead

12.3 Guardrail effectiveness
- Enable low-rate policing and confirm GW remains stable under load

Completion Checklist
--------------------
[ ] OS + deps installed
[ ] GW installed/configured
[ ] nftables baseline ok
[ ] PKI root + tenant CA + cert issuance ok
[ ] Tenant VRFs created; isolation validated
[ ] IPsec + BGP up; routes validated
[ ] DNS forward + rewrite validated
[ ] Squid explicit + CONNECT validated (transparent optional)
[ ] Reverse proxy mTLS validated (server cert per app)
[ ] Revocation validated
[ ] Inspection add-on installed
[ ] Bidir mirror validated; allow-list + policing validated
[ ] Resilience + performance smoke complete
