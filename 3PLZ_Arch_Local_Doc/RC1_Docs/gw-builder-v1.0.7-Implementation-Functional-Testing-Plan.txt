GW-Builder v1.0.8 — Comprehensive Implementation & Functional Testing Plan
==========================================================================

Scope
-----
Validate end-to-end build and operation:
- Install + deps (Rocky Linux 9)
- Base networking + interface roles
- nftables baseline
- VRF tenant isolation
- strongSwan IPsec VTI (IKEv2 PSK) + per-tenant BGP (FRR)
- DNS conditional forward + tenant rewrite (namespace preservation)
- Forward proxy (Squid) explicit + CONNECT + optional transparent
- Reverse proxy (NGINX) per-app mTLS enforcement + per-app server certs
- PKI (Root + tenant intermediate + user/server cert issuance, revoke/CRL)
- Inspection export add-on (ERSPAN/VXLAN mirror) with guardrails
- SSH/SFTP reverse proxy add-on (HAProxy TCP) with nftables upstream allow-list guardrail

SECTION 1 — Install & Baseline
------------------------------
1.1 OS
  cat /etc/os-release
  uname -r

1.2 Packages
  rpm -q iproute nftables strongswan frr nginx squid openssl haproxy || true

1.3 Layout
  test -x /opt/gw-builder/gwctl.sh
  ls -l /opt/gw-builder/tenants || true

SECTION 2 — Base Networking
---------------------------
  ip -br link
  ip -br addr
  ip route

SECTION 3 — nftables baseline
-----------------------------
  systemctl enable --now nftables
  nft list ruleset

SECTION 4 — PKI (standalone)
----------------------------
4.1 Root
  sudo /opt/gw-builder/pki-bootstrap.sh init-root --cn "Outlan Root CA"
4.2 Tenant intermediate
  sudo /opt/gw-builder/pki-bootstrap.sh init-tenant --tenant tenantA
4.3 Issue user cert
  openssl req -new -newkey rsa:2048 -nodes -keyout alice.key.pem -out alice.csr.pem -subj "/CN=alice@outlan.net"
  /opt/gw-builder/pki-issue.sh sign-user-csr --tenant tenantA --email alice@outlan.net --csr alice.csr.pem --outdir ./alice
4.4 Issue server cert
  /opt/gw-builder/pki-issue.sh issue-server --tenant tenantA --fqdn sap.outlan.net --outdir ./sap
4.5 Revoke + CRL
  sudo /opt/gw-builder/pki-revoke.sh revoke-user --tenant tenantA --email alice@outlan.net

SECTION 5 — Tenant Create + VRF Isolation
-----------------------------------------
  sudo gwctl tenant-create tenantA
  sudo gwctl tenant-create tenantB
  ip vrf show | egrep "tenantA|tenantB" || true
  ip route show vrf vrf-tenantA
  ip route show vrf vrf-tenantB

SECTION 6 — IPsec VTI + BGP
---------------------------
  sudo gwctl tenant-start tenantA
  sudo ipsec statusall | egrep -i "ESTABLISHED|INSTALLED|tenantA" -n || true
  vtysh -c "show ip bgp summary" | egrep "Neighbor|Estab|Up" -n || true

SECTION 7 — DNS Forward + Rewrite
---------------------------------
  ss -lntup | grep :53 || true
  dig @172.16.100.3 sap.outlan.net

SECTION 8 — Forward Proxy (Squid)
---------------------------------
  ss -lntup | grep 3128 || true
  curl -x http://172.16.100.1:3128 http://example.com -I
  curl -x http://172.16.100.1:3128 https://example.com -I

SECTION 9 — Reverse Proxy (mTLS)
--------------------------------
9.1 blocked without cert
  curl -k https://sap.outlan.net --resolve sap.outlan.net:443:<tenant-vip> -I || true
9.2 allowed with cert
  curl --cert ./alice/alice@outlan.net.cert.pem --key ./alice/alice.key.pem -k https://sap.outlan.net --resolve sap.outlan.net:443:<tenant-vip> -I

SECTION 10 — Inspection Export Add-on (Option A)
------------------------------------------------
Install:
  # use gw-inspection-v0.1.1.zip (previous deliverable)
Configure tenantA.conf:
  INSPECTION_EXPORT_MODE=tap
  DECRYPT_IFACE=dec-tenantA
  INSPECTION_TAP_TYPE=erspan
  INSPECTION_TAP_DST_IP=<appliance-ip>
  INSPECTION_TAP_KEY=1001
  INSPECTION_TAP_ALLOWLIST=<appliance-ip>
  INSPECTION_TAP_EGRESS_IF=eth0
Validate:
  tc -s filter show dev dec-tenantA ingress
  tc -s filter show dev dec-tenantA egress
  ip -d link show erspan-tenantA
  nft list table inet gw_inspect_allow

SECTION 11 — SSH/SFTP Reverse Proxy Add-on (external)
-----------------------------------------------------
11.1 Install add-on + HAProxy
  sudo dnf install -y haproxy
  unzip gw-sshproxy-v0.1.0.zip
  cd gw-sshproxy-v0.1.0
  sudo ./gw-sshproxyctl.sh install

11.2 Enable tenant + allowlist guardrail
Edit /opt/gw-builder/tenants/tenantA.conf:
  SSH_PROXY_MODE=on
  SSH_PROXY_UPSTREAM_ALLOWLIST=93.77.89.1
  SSH_PROXY_EGRESS_IF=eth0

11.3 Create service and apply
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh add tenantA remote-host 172.16.100.50 93.77.89.1 22
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh apply tenantA

11.4 DNS rewrite
  remote-host.outlan.net -> 172.16.100.50
Validate:
  dig @172.16.100.3 remote-host.outlan.net

11.5 Connectivity
  ssh -vvv user@remote-host.outlan.net
  sftp -vvv user@remote-host.outlan.net

SECTION 12 — SSH nftables Allow-list Guardrail Validation
---------------------------------------------------------
12.1 Verify nft table exists
  nft list table inet gw_ssh_tenantA
12.2 Positive
  SSH to allowlisted upstream succeeds
12.3 Negative
- Change service upstream IP to 93.77.89.2 (not in allowlist)
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh remove-service tenantA remote-host
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh add tenantA remote-host 172.16.100.50 93.77.89.2 22
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh apply tenantA
- Expect SSH connection to fail (dropped)

SECTION 13 — Idempotency + Cleanup
----------------------------------
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh apply tenantA
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh apply tenantA
  sudo /opt/gw-sshproxy/gw-sshproxyctl.sh remove tenantA
  ip link show sshvip-tenantA || true
  nft list table inet gw_ssh_tenantA || true
